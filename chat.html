<div style="margin-bottom: 10px">
  <input type="text" id="message" />
  <button id="send" disabled>Send</button>
</div>

<textarea
  id="list_messages"
  disabled
  style="width: 100%; height: 200px"
></textarea>

<script>
  const message_input = document.getElementById("message");
  const send_button = document.getElementById("send");
  const list_messages = document.getElementById("list_messages");

  const configuration = {
    iceServers: [
      {
        urls: "stun:stun.relay.metered.ca:80",
      },
      {
        urls: "turn:a.relay.metered.ca:80",
        username: "ccb803a53ccc0887680ef973",
        credential: "4eR9jWY5e1d2G7F4",
      },
      {
        urls: "turn:a.relay.metered.ca:80?transport=tcp",
        username: "ccb803a53ccc0887680ef973",
        credential: "4eR9jWY5e1d2G7F4",
      },
      {
        urls: "turn:a.relay.metered.ca:443",
        username: "ccb803a53ccc0887680ef973",
        credential: "4eR9jWY5e1d2G7F4",
      },
      {
        urls: "turn:a.relay.metered.ca:443?transport=tcp",
        username: "ccb803a53ccc0887680ef973",
        credential: "4eR9jWY5e1d2G7F4",
      },
    ],
  };

  const peerConnection = new RTCPeerConnection(configuration);

  // Chat
  let dataChannel = peerConnection.createDataChannel(chat_name());
  dataChannel.addEventListener("open", () => {
    send_button.disabled = false;
  });
  dataChannel.addEventListener("message", (event) => {
    list_messages.value += "Other: " + event.data + "\n";
  });
  send_button.addEventListener("click", () => {
    dataChannel.send(message_input.value);
    list_messages.value += "Me: " + event.data + "\n";
    message_input.value = "";
  });

  peerConnection.addEventListener("datachannel", (event) => {
    dataChannel = event.channel;
    console.log("DataChannel", dataChannel);
    dataChannel.addEventListener("open", () => {
      send_button.disabled = false;
    });
    dataChannel.addEventListener("message", (event) => {
      list_messages.value += "Other: " + event.data + "\n";
    });
  });

  peerConnection.addEventListener("connectionstatechange", (event) => {
    if (peerConnection.connectionState === "connected") {
      console.log("Peers WebRTC conexión establecida");
    }
  });

  const socket = new WebSocket("wss://ws-gw.omnitracs.online");

  socket.onopen = () => {
    console.log("WebSocket conexión establecida");
    socket.onmessage = (event) => {
      const message = JSON.parse(event.data);
      if (message.type === "offer") {
        peerConnection.setRemoteDescription(new RTCSessionDescription(message));
        peerConnection.createAnswer().then((answer) => {
          peerConnection.setLocalDescription(answer);
          socket.send(JSON.stringify(answer));
        });
      } else if (message.type === "answer") {
        peerConnection.setRemoteDescription(new RTCSessionDescription(message));
      } else if (message.candidate) {
        peerConnection.addIceCandidate(message);
      }
    };
    peerConnection.createOffer().then((offer) => {
      peerConnection.setLocalDescription(offer);
      socket.send(JSON.stringify(offer));
    });
    setInterval(() => {
      socket.send(JSON.stringify({ type: "ping" }));
    }, 30000);
  };

  peerConnection.addEventListener("icecandidate", (event) => {
    if (event.candidate) {
      socket.send(JSON.stringify(event.candidate));
    }
  });

  socket.onclose = () => {
    console.log("WebSocket conexión cerrada");
  };

  function chat_name() {
    const caracteres =
      "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
    let nombre = "";
    for (let i = 0; i < 5; i++) {
      nombre += caracteres[Math.floor(Math.random() * caracteres.length)];
    }
    return nombre;
  }
</script>

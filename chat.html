<script>
  const configuration = {
    iceServers: [
      {
        urls: "stun:stun.relay.metered.ca:80",
      },
      {
        urls: "turn:a.relay.metered.ca:80",
        username: "ccb803a53ccc0887680ef973",
        credential: "4eR9jWY5e1d2G7F4",
      },
      {
        urls: "turn:a.relay.metered.ca:80?transport=tcp",
        username: "ccb803a53ccc0887680ef973",
        credential: "4eR9jWY5e1d2G7F4",
      },
      {
        urls: "turn:a.relay.metered.ca:443",
        username: "ccb803a53ccc0887680ef973",
        credential: "4eR9jWY5e1d2G7F4",
      },
      {
        urls: "turn:a.relay.metered.ca:443?transport=tcp",
        username: "ccb803a53ccc0887680ef973",
        credential: "4eR9jWY5e1d2G7F4",
      },
    ],
  };

  const peerConnection = new RTCPeerConnection(configuration);

  peerConnection.ontrack = (event) => {
    const videoElement = document.getElementById("remote-video");
    videoElement.srcObject = event.streams[0];
  };

  peerConnection.createDataChannel("chat");
  let dataChannel;

  peerConnection.addEventListener("datachannel", (event) => {
    dataChannel = event.channel;

    dataChannel.addEventListener("open", () => {
      console.log("DataChannel abierta");
      dataChannel.send("Hello World!");
    });

    dataChannel.addEventListener("message", (event) => {
      console.log("Message from datachannel:", event.data);
    });
  });

  peerConnection.oniceconnectionstatechange = (event) => {
    if (peerConnection.iceConnectionState === "connected") {
      console.log("WebRTC conexi贸n establecida");
    }
  };

  peerConnection.addEventListener("connectionstatechange", (event) => {
    if (peerConnection.connectionState === "connected") {
      console.log("Peers WebRTC conexi贸n establecida");
    }
  });

  const socket = new WebSocket("wss://ws-gw.omnitracs.online");

  socket.onopen = () => {
    console.log("WebSocket conexi贸n establecida");
    socket.onmessage = (event) => {
      const message = JSON.parse(event.data);
      if (message.type === "offer") {
        peerConnection.setRemoteDescription(new RTCSessionDescription(message));
        peerConnection.createAnswer().then((answer) => {
          peerConnection.setLocalDescription(answer);
          socket.send(JSON.stringify(answer));
        });
      } else if (message.type === "answer") {
        console.log("Answer from remote peer");
        peerConnection.setRemoteDescription(new RTCSessionDescription(message));
      } else if (message.candidate) {
        console.log("candidate from remote peer");
        peerConnection.addIceCandidate(message);
      }
    };
    peerConnection.createOffer().then((offer) => {
      peerConnection.setLocalDescription(offer);
      socket.send(JSON.stringify(offer));
    });
    setInterval(() => {
      socket.send(JSON.stringify({ type: "ping" }));
    }, 30000);
  };

  peerConnection.addEventListener("icecandidate", (event) => {
    if (event.candidate) {
      socket.send(JSON.stringify(event.candidate));
    }
  });

  socket.onclose = () => {
    console.log("WebSocket conexi贸n cerrada");
  };
</script>

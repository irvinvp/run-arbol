<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <title>Chat</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
  </head>
  <body>
    <div>
      <p id="status">Status: Offline</p>
      <p id="data_status">Channel: Disconnected</p>
    </div>
    <div style="margin-bottom: 10px">
      <input type="text" id="message" />
      <button id="send" disabled>Send</button>
    </div>

    <textarea
      id="list_messages"
      disabled
      style="width: 100%; height: 200px"
    ></textarea>

    <script>
      const message_input = document.getElementById("message");
      const send_button = document.getElementById("send");
      const list_messages = document.getElementById("list_messages");
      const status = document.getElementById("status");
      const data_status = document.getElementById("data_status");

      const configuration = {
        iceServers: [
          {
            urls: "stun:stun.relay.metered.ca:80",
          },
          {
            urls: "turn:a.relay.metered.ca:80",
            username: "ccb803a53ccc0887680ef973",
            credential: "4eR9jWY5e1d2G7F4",
          },
          {
            urls: "turn:a.relay.metered.ca:80?transport=tcp",
            username: "ccb803a53ccc0887680ef973",
            credential: "4eR9jWY5e1d2G7F4",
          },
          {
            urls: "turn:a.relay.metered.ca:443",
            username: "ccb803a53ccc0887680ef973",
            credential: "4eR9jWY5e1d2G7F4",
          },
          {
            urls: "turn:a.relay.metered.ca:443?transport=tcp",
            username: "ccb803a53ccc0887680ef973",
            credential: "4eR9jWY5e1d2G7F4",
          },
        ],
      };

      const peerConnection = new RTCPeerConnection(configuration);

      // Chat
      let dataChannel = peerConnection.createDataChannel(chat_name());
      dataChannel.addEventListener("open", () => {
        send_button.disabled = false;
        data_status.innerText = "Channel: connected";
      });
      dataChannel.addEventListener("message", (event) => {
        list_messages.value =
          "Peer: " + event.data + "\n" + list_messages.value;
        list_messages.scrollTop = 0;
        if (event.data === "ping") {
          dataChannel.send("pong");
        }
      });
      send_button.addEventListener("click", () => {
        dataChannel.send(message_input.value);
        list_messages.value =
          "Me: " + message_input.value + "\n" + list_messages.value;
        message_input.value = "";
        list_messages.scrollTop = 0;
      });
      message_input.addEventListener("keyup", (event) => {
        if (event.keyCode === 13) {
          event.preventDefault();
          send_button.click();
        }
      });
      dataChannel.addEventListener("close", () => {
        send_button.disabled = true;
        data_status.innerText = "Channel: Disconnected";
      });

      peerConnection.addEventListener("datachannel", (event) => {
        dataChannel = event.channel;
        console.log("DataChannel", dataChannel);
        dataChannel.addEventListener("open", () => {
          send_button.disabled = false;
          data_status.innerText = "Channel: connected";
        });
        dataChannel.addEventListener("message", (event) => {
          list_messages.value =
            "Peer: " + event.data + "\n" + list_messages.value;
          list_messages.scrollTop = 0;
          if (event.data === "ping") {
            dataChannel.send("pong");
          }
        });
        dataChannel.addEventListener("close", () => {
          send_button.disabled = true;
          data_status.innerText = "Channel: Disconnected";
        });
      });

      peerConnection.addEventListener("connectionstatechange", (event) => {
        if (peerConnection.connectionState === "connected") {
          console.log("Peers WebRTC conexi贸n establecida");
          status.innerText = "Status: Online";
        }
        if (peerConnection.connectionState === "disconnected") {
          console.log("Peers WebRTC conexi贸n cerrada");
          data_status.innerText = "Channel: Disconnected";
          status.innerText = "Status: Offline";
          send_button.disabled = true;
        }
      });

      const socket = new WebSocket("wss://ws-gw.omnitracs.online");

      socket.onopen = () => {
        console.log("WebSocket conexi贸n establecida");
        socket.onmessage = (event) => {
          const message = JSON.parse(event.data);
          if (message.type === "offer") {
            peerConnection.setRemoteDescription(
              new RTCSessionDescription(message)
            );
            peerConnection.createAnswer().then((answer) => {
              peerConnection.setLocalDescription(answer);
              socket.send(JSON.stringify(answer));
            });
          } else if (message.type === "answer") {
            peerConnection.setRemoteDescription(
              new RTCSessionDescription(message)
            );
          } else if (message.candidate) {
            peerConnection.addIceCandidate(message);
          }
        };
        peerConnection.createOffer().then((offer) => {
          peerConnection.setLocalDescription(offer);
          socket.send(JSON.stringify(offer));
        });
        setInterval(() => {
          socket.send(JSON.stringify({ type: "ping" }));
        }, 30000);
      };

      peerConnection.addEventListener("icecandidate", (event) => {
        if (event.candidate) {
          socket.send(JSON.stringify(event.candidate));
        }
      });

      socket.onclose = () => {
        console.log("WebSocket conexi贸n cerrada");
      };

      function chat_name() {
        const caracteres =
          "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
        let nombre = "";
        for (let i = 0; i < 5; i++) {
          nombre += caracteres[Math.floor(Math.random() * caracteres.length)];
        }
        return nombre;
      }
    </script>
  </body>
</html>

<input type="text" id="message" />
<button id="send" disabled>Send</button>
<textarea id="list_messages" disabled></textarea>
<video id="remote-video" autoplay></video>

<script>
  const message_input = document.getElementById("message");
  const send_button = document.getElementById("send");
  const list_messages = document.getElementById("list_messages");

  const configuration = {
    iceServers: [
      {
        urls: "stun:stun.relay.metered.ca:80",
      },
      {
        urls: "turn:a.relay.metered.ca:80",
        username: "ccb803a53ccc0887680ef973",
        credential: "4eR9jWY5e1d2G7F4",
      },
      {
        urls: "turn:a.relay.metered.ca:80?transport=tcp",
        username: "ccb803a53ccc0887680ef973",
        credential: "4eR9jWY5e1d2G7F4",
      },
      {
        urls: "turn:a.relay.metered.ca:443",
        username: "ccb803a53ccc0887680ef973",
        credential: "4eR9jWY5e1d2G7F4",
      },
      {
        urls: "turn:a.relay.metered.ca:443?transport=tcp",
        username: "ccb803a53ccc0887680ef973",
        credential: "4eR9jWY5e1d2G7F4",
      },
    ],
  };

  const peerConnection = new RTCPeerConnection(configuration);

  peerConnection.ontrack = (event) => {
    const videoElement = document.getElementById("remote-video");
    videoElement.srcObject = event.streams[0];
  };

  peerConnection.addEventListener("datachannel", (event) => {
    console.log("Yo recibo la conexión");
    let dataChannel = event.channel;

    dataChannel.addEventListener("open", () => {
      send_button.disabled = false;
    });

    dataChannel.addEventListener("message", (event) => {
      list_messages.value += event.data + "\n";
    });
  });

  peerConnection.addEventListener("connectionstatechange", (event) => {
    if (peerConnection.connectionState === "connected") {
      console.log("Peers WebRTC conexión establecida");
    }
  });

  const socket = new WebSocket("wss://ws-gw.omnitracs.online");

  socket.onopen = () => {
    console.log("WebSocket conexión establecida");
    socket.onmessage = (event) => {
      const message = JSON.parse(event.data);
      if (message.type === "offer") {
        peerConnection.setRemoteDescription(new RTCSessionDescription(message));
        peerConnection.createAnswer().then((answer) => {
          peerConnection.setLocalDescription(answer);
          socket.send(JSON.stringify(answer));
        });
      } else if (message.type === "answer") {
        console.log("Yo creo la conexión");
        peerConnection.setRemoteDescription(new RTCSessionDescription(message));

        // Chat
        let dataChannel = peerConnection.createDataChannel("chat");
        dataChannel.addEventListener("open", () => {
          send_button.disabled = false;
        });
        dataChannel.addEventListener("message", (event) => {
          list_messages.value += event.data + "\n";
        });
        send_button.addEventListener("click", () => {
          dataChannel.send(message_input.value);
        });
      } else if (message.candidate) {
        console.log("candidate from remote peer");
        peerConnection.addIceCandidate(message);
      }
    };
    peerConnection.createOffer().then((offer) => {
      peerConnection.setLocalDescription(offer);
      socket.send(JSON.stringify(offer));
    });
    setInterval(() => {
      socket.send(JSON.stringify({ type: "ping" }));
    }, 30000);
  };

  peerConnection.addEventListener("icecandidate", (event) => {
    if (event.candidate) {
      socket.send(JSON.stringify(event.candidate));
    }
  });

  socket.onclose = () => {
    console.log("WebSocket conexión cerrada");
  };
</script>
